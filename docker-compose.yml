version: '3'
services:
    db:
        image: mariadb:10
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: db
    queue:
        image: rabbitmq:3.7-management
        ports:
            - 15672:15672
    app:
        image: 'tienvx/mbt-example-app'
        ports:
            - 81:80
        depends_on:
            - db
            - api
    api:
        image: 'tienvx/mbt-api'
        ports:
            - 80:80
        volumes:
            - './config/jwt:/usr/local/src/app/config/jwt'
            - './config/packages/dev/models:/usr/local/src/app/config/packages/dev/models'
            - './src/Subject:/usr/local/src/app/src/Subject'
            - './src/Helper:/usr/local/src/app/src/Helper'
        depends_on:
            - queue
            - db
        environment:
            DATABASE_URL: 'mysql://root:root@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
    worker:
        image: 'tienvx/mbt-e2e-worker'
        volumes:
            - './config/packages/dev/models:/usr/local/src/app/config/packages/dev/models'
            - './src/Subject:/usr/local/src/app/src/Subject'
            - './src/Helper:/usr/local/src/app/src/Helper'
        links:
            - app:example.com
        depends_on:
            - queue
            - db
        environment:
            DATABASE_URL: 'mysql://root:root@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
    admin:
        image: 'tienvx/mbt-admin'
        ports:
            - 82:5000
        depends_on:
            - api
        environment:
            API_URL: 'http://api/api'
