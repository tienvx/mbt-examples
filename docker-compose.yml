version: '3'
services:
    db:
        image: mariadb:10
        environment:
            MYSQL_DATABASE: db
            MYSQL_USER: user
            MYSQL_PASSWORD: pass
            MYSQL_ROOT_PASSWORD: root
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "--user=user", "--password=pass", "--silent"]
            interval: 30s
            timeout: 10s
            retries: 5
    queue:
        image: rabbitmq:3.7-management
        ports:
            - 15672:15672
        healthcheck:
            test: ["CMD", "rabbitmqctl", "status"]
            interval: 30s
            timeout: 10s
            retries: 5
    app:
        image: 'tienvx/mbt-example-app'
        ports:
            - 81:80
        healthcheck:
            test: ["CMD", "nc", "-z", "localhost", "80"]
            interval: 30s
            timeout: 10s
            retries: 5
        depends_on:
            - db
        restart: on-failure
    api:
        image: "tienvx/mbt-api:${MBT_VERSION}"
        ports:
            - 80:80
        healthcheck:
            test: ["CMD", "nc", "-z", "localhost", "80"]
            interval: 30s
            timeout: 10s
            retries: 5
        depends_on:
            - queue
            - db
        restart: on-failure
        environment:
            APP_ENV: prod
            DATABASE_URL: 'mysql://user:pass@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
            USER_PASSWORD: '$$2y$$13$$gWuD7B7irvHWJo7kMx9w8eJpLEuSZiR5iMgK1p2foCeYPsjsAk0k.'
            ADMIN_PASSWORD: '$$2y$$13$$3rT10fXyh9o12mVSaPnbmu92HX3anslUtXabjXu6zdYojpopeFVba'
        deploy:
            placement:
                constraints: [node.role == manager]
            replicas: 1
            restart_policy:
                condition: on-failure
    worker:
        image: "tienvx/mbt-example-worker:${MBT_VERSION}"
        links:
            - app:example.com
        depends_on:
            - queue
            - db
        restart: on-failure
        environment:
            APP_ENV: prod
            DATABASE_URL: 'mysql://user:pass@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
            MAILER_URL: 'smtp://localhost:25?encryption=ssl&auth_mode=login&username=&password='
        deploy:
            placement:
                constraints: [node.role == worker]
            replicas: 4
            restart_policy:
                condition: on-failure
    admin:
        image: "tienvx/mbt-admin:${MBT_VERSION}"
        ports:
            - 82:80
        depends_on:
            - api
        environment:
            REACT_APP_API_URL: 'http://localhost/api'
            REACT_APP_MBT_API_URL: 'http://localhost/mbt-api'
