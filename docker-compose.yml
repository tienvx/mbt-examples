version: '3'
networks:
    selenoid:
        external:
            name: selenoid
volumes:
    source:
services:
    db:
        image: jbergstroem/mariadb-alpine
        networks:
            selenoid: null
        env_file:
            - docker/.env-db
    hub:
        image: "selenoid/hub"
        networks:
            selenoid: null
        volumes:
            - "$PWD/docker/selenoid/config/:/etc/selenoid/:ro"
            - "/var/run/docker.sock:/var/run/docker.sock"
            - "$PWD/docker/selenoid/video/:/opt/selenoid/video"
            - "$PWD/docker/selenoid/logs/:/opt/selenoid/logs"
        environment:
            - OVERRIDE_VIDEO_OUTPUT_DIR=$PWD/docker/selenoid/video/
        command: ["-conf", "/etc/selenoid/browsers.json", "-limit", "5", "-video-output-dir", "/opt/selenoid/video", "-log-output-dir", "/opt/selenoid/logs", "-container-network", "selenoid"]
    selenoid-ui:
        image: "aerokube/selenoid-ui"
        networks:
            selenoid: null
        ports:
            - "84:8080"
        command: ["--selenoid-uri", "http://hub:4444"]
    minio:
        image:   'minio/minio'
        networks:
            selenoid: null
        ports:
            - 83:9000
        env_file:
            - docker/.env-minio
        entrypoint: sh
        command: -c 'mkdir -p /data/mbt && minio server --address :9000 /data'
    app:
        image: 'tienvx/mbt-example-app'
        networks:
            selenoid:
                aliases:
                    - example.com
        ports:
            - 81:80
        depends_on:
            - db
    api-nginx:
        image: nginx:alpine
        networks:
            selenoid: null
        ports:
            - 82:80
        volumes:
            - source:/usr/local/src/app
            - ./docker/build/api-nginx.conf:/etc/nginx/conf.d/default.conf
        depends_on:
            - api
    api:
        build:
            context: .
            dockerfile: docker/build/Dockerfile.api
        networks:
            selenoid: null
        depends_on:
            - db
            - minio
        env_file:
            - docker/.env
        volumes:
            - source:/usr/local/src/app
    worker:
        build:
            context: .
            dockerfile: docker/build/Dockerfile.worker
        networks:
            selenoid: null
        depends_on:
            - db
            - minio
        env_file:
            - docker/.env
        command: ["wait-for", "db:3306", "--timeout=99", "--", "php", "/usr/local/src/app/bin/console", "messenger:consume", "async"]
    admin:
        image: "tienvx/mbt-admin:v1.15.1"
        networks:
            selenoid: null
        ports:
            - 80:80
        depends_on:
            - api
        environment:
            API_URL: 'http://localhost:82'
