version: '3'
services:
    db:
        image: mariadb:10
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: db
    queue:
        image: rabbitmq:3.7-management
        ports:
            - 15672:15672
    app:
        image: 'tienvx/mbt-example-app'
        ports:
            - 81:80
        depends_on:
            - db
    api:
        image: "tienvx/mbt-api:${MBT_VERSION}"
        ports:
            - 80:80
        volumes:
            - './config/jwt:/usr/local/src/app/config/jwt'
            - './config/packages/dev/models:/usr/local/src/app/config/packages/dev/models'
            - './src/Subject:/usr/local/src/app/src/Subject'
            - './src/Helper:/usr/local/src/app/src/Helper'
            - './screenshots:/usr/local/src/app/var/screenshots'
        depends_on:
            - queue
            - db
        environment:
            DATABASE_URL: 'mysql://root:root@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
            USER_PASSWORD: '$$2y$$13$$gWuD7B7irvHWJo7kMx9w8eJpLEuSZiR5iMgK1p2foCeYPsjsAk0k.'
            ADMIN_PASSWORD: '$$2y$$13$$3rT10fXyh9o12mVSaPnbmu92HX3anslUtXabjXu6zdYojpopeFVba'
    worker:
        build:
            context: ./docker/build/mbt-custom-worker
            dockerfile: Dockerfile
            args:
                MBT_VERSION: ${MBT_VERSION}
        #image: "tienvx/mbt-e2e-worker:${MBT_VERSION}"
        volumes:
            - './config/packages/dev/models:/usr/local/src/app/config/packages/dev/models'
            - './config/packages/dev/reporters.yaml:/usr/local/src/app/config/packages/dev/reporters.yaml'
            - './src/Subject:/usr/local/src/app/src/Subject'
            - './src/Helper:/usr/local/src/app/src/Helper'
            - './screenshots:/usr/local/src/app/var/screenshots'
        links:
            - app:example.com
        depends_on:
            - queue
            - db
        environment:
            DATABASE_URL: 'mysql://root:root@db:3306/db'
            MESSENGER_TRANSPORT_DSN: 'amqp://guest:guest@queue:5672/%2f/messages'
            MAILER_URL: 'smtp://localhost:25?encryption=ssl&auth_mode=login&username=&password='
    admin:
        image: "tienvx/mbt-admin:${MBT_VERSION}"
        ports:
            - 82:80
        depends_on:
            - api
        environment:
            API_URL: 'http://api/api'
